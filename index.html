<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïµÔ∏è Command Center V5.1 | Biotchelly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- JOBS DARK THEME DNA --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            background-image: radial-gradient(circle at 50% 50%, #1e293b 1px, transparent 1px);
            background-size: 24px 24px;
            color: #cbd5e1;
            transition: all 0.3s ease;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Inputs Padronizados */
        .input-pro {
            @apply w-full bg-slate-900 border border-slate-700 rounded-md p-3 text-white placeholder-slate-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition text-sm shadow-inner;
        }
        
        /* Checkbox Custom */
        .checkbox-pro {
            @apply w-4 h-4 text-blue-600 bg-slate-800 border-slate-600 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer;
        }

        /* Toggle Switch Customization */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-in; }

        /* Tabs Logic */
        .tab-btn { @apply px-6 py-3 font-bold text-sm uppercase tracking-wide border-b-2 border-transparent transition-all duration-200 text-slate-500 hover:text-white cursor-pointer; }
        .tab-btn.active { @apply border-blue-500 text-blue-400 bg-slate-800/50 rounded-t-lg; }
        
        .tab-content { @apply hidden; }
        .tab-content.active { @apply block fade-in; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        /* Light Mode Overrides */
        html.light-mode body {
            background-color: #f8fafc;
            background-image: radial-gradient(circle at 50% 50%, #cbd5e1 1px, transparent 1px);
            color: #334155;
        }
        html.light-mode .bg-slate-900 { background-color: #ffffff; border-color: #e2e8f0; }
        html.light-mode .bg-slate-800\/40 { background-color: #ffffff; border-color: #e2e8f0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        html.light-mode .input-pro { background-color: #f1f5f9; border-color: #cbd5e1; color: #0f172a; }
        html.light-mode .text-white { color: #0f172a; }
        html.light-mode .text-slate-400 { color: #64748b; }
        
        /* Bot√µes Estilo Jobs */
        .btn-jobs {
            @apply bg-blue-600 hover:bg-blue-500 text-slate-200 shadow-md transition transform hover:-translate-y-0.5 font-bold;
        }
    </style>
</head>
<body class="antialiased min-h-screen p-4 md:p-8">

    <!-- ‚öôÔ∏è CONFIG MODAL -->
    <div id="configModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center backdrop-blur-sm transition-all">
        <div class="bg-slate-800 p-8 rounded-xl border border-slate-600 w-full max-w-lg shadow-2xl relative bg-slate-900">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                <i class="fa-solid fa-cogs text-blue-500"></i> Configura√ß√£o do Motor
            </h2>
            
            <div class="space-y-5">
                <!-- URL Kestra -->
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-400 mb-1">URL do Kestra (Backend)</label>
                    <div class="flex gap-2">
                        <input type="text" id="kestraUrl" placeholder="https://kestra.seu-dominio.com" class="input-pro flex-1">
                        <button onclick="testConnection()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded-md text-xs font-bold transition">
                            <i class="fa-solid fa-plug"></i> TESTAR
                        </button>
                    </div>
                    <p id="connectionStatus" class="text-xs mt-2 h-4 font-mono"></p>
                </div>

                <!-- Namespace & Flow -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase font-bold text-slate-400 mb-1">Namespace</label>
                        <input type="text" id="kestraNamespace" value="biotchellymcp" class="input-pro">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-slate-400 mb-1">Flow ID</label>
                        <input type="text" id="kestraFlowId" value="06cacador_de_leads_pro_v4" class="input-pro">
                    </div>
                </div>

                <!-- API Tokens -->
                <div class="space-y-3 pt-2 border-t border-slate-700">
                    <div>
                        <label class="block text-xs uppercase font-bold text-emerald-500 mb-1">Token Casa dos Dados</label>
                        <input type="text" id="apiTokenCasaDados" placeholder="Cole seu token aqui" class="input-pro border-emerald-900 focus:border-emerald-500">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-red-500 mb-1">Token SerpApi (Google Maps)</label>
                        <input type="text" id="apiTokenSerpApi" placeholder="Cole sua chave SerpApi" class="input-pro border-red-900 focus:border-red-500">
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3 pt-4 border-t border-slate-700">
                <button onclick="toggleConfig()" class="px-4 py-2 text-slate-400 hover:text-white font-bold transition">Cancelar</button>
                <button onclick="saveConfig()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded font-bold shadow-lg transition">Salvar Configura√ß√£o</button>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <main class="w-full max-w-7xl mx-auto space-y-6">
        
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-6 pb-6 border-b border-slate-800">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 flex items-center justify-center bg-slate-800 rounded-lg border border-slate-700 shadow-lg">
                    <i class="fa-solid fa-crosshairs text-blue-500 text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-black text-white tracking-tight">COMMAND CENTER <span class="text-blue-500">V5.1</span></h1>
                    <p class="text-slate-500 text-xs font-mono font-bold uppercase tracking-widest">Biotchelly Intelligence Systems</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                 <button onclick="toggleTheme()" id="themeBtn" class="px-4 py-2 btn-jobs rounded-md text-sm">
                    <i class="fa-solid fa-sun"></i>
                </button>
                 <button onclick="clearForm()" class="px-4 py-2 btn-jobs rounded-md text-xs uppercase flex items-center gap-2">
                    <i class="fa-solid fa-eraser"></i> Limpar
                </button>
                <button onclick="toggleConfig()" class="px-4 py-2 btn-jobs rounded-md flex items-center gap-2 text-xs uppercase">
                    <i class="fa-solid fa-gear"></i> Configurar
                </button>
            </div>
        </div>

        <!-- TABS NAVIGATION -->
        <div class="flex border-b border-slate-700 mb-6 overflow-x-auto">
            <button class="tab-btn active" onclick="openTab('tab-cacador', this)">
                <i class="fa-solid fa-database mr-2"></i> Ca√ßador (Dados)
            </button>
            <button class="tab-btn" onclick="openTab('tab-maps', this)">
                <i class="fa-solid fa-map-location-dot mr-2"></i> Google Maps
            </button>
            <button class="tab-btn" onclick="openTab('tab-sniper', this)">
                <i class="fa-solid fa-bullseye mr-2"></i> Sniper (Disparo)
            </button>
        </div>

        <form id="hunterForm" onsubmit="event.preventDefault(); startHunt();">
            
            <!-- üïµÔ∏è ABA 1: CA√áADOR -->
            <div id="tab-cacador" class="tab-content active space-y-8 fade-in">
                <!-- 1. IDENTIFICA√á√ÉO & RESULTADOS -->
                <section class="bg-slate-800/40 border border-slate-700 rounded-lg p-6 shadow-sm">
                    <div class="mb-4 flex items-center gap-2 border-b border-slate-700/50 pb-2">
                        <i class="fa-solid fa-magnifying-glass text-blue-500"></i>
                        <h3 class="text-sm font-bold text-white uppercase">Identifica√ß√£o</h3>
                    </div>

                    <div class="space-y-6">
                        <!-- Linha 1: CNPJ e RESULTADOS -->
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                            <div class="md:col-span-8">
                                <label class="block text-xs font-bold text-slate-400 mb-1">CNPJ</label>
                                <div class="flex gap-2">
                                    <input type="text" id="cnpj" placeholder="Ex: 33.000.167/0001-01" class="input-pro">
                                    <button type="button" class="btn-jobs px-4 rounded-md text-xs whitespace-nowrap">Inserir em Lote</button>
                                </div>
                            </div>
                            
                            <!-- üìä PAINEL DE RESULTADOS (CA√áADOR) -->
                            <div class="md:col-span-4 bg-slate-900 border border-slate-700 rounded-md p-3 flex flex-col justify-center">
                                <span class="text-[10px] uppercase font-bold text-slate-500 mb-1">Status da √öltima Miss√£o</span>
                                <div class="flex justify-between items-end">
                                    <div>
                                        <span class="text-2xl font-black text-emerald-400" id="dashFound">0</span>
                                        <span class="text-xs text-slate-400">Encontradas</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-2xl font-black text-blue-400" id="dashSaved">0</span>
                                        <span class="text-xs text-slate-400">Salvas</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BUSCA TEXTUAL -->
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">BUSCA TEXTUAL</label>
                            <input type="text" id="termo" placeholder="Digite o termo e aperte enter (Ex: Barbearia, Padaria...)" class="input-pro text-lg">
                            
                            <div class="flex gap-6 mt-3 pl-1">
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="checkbox" id="checkRazao" checked class="checkbox-pro">
                                    <span class="text-sm text-slate-400 group-hover:text-white transition">Raz√£o Social</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="checkbox" id="checkFantasia" checked class="checkbox-pro">
                                    <span class="text-sm text-slate-400 group-hover:text-white transition">Nome Fantasia</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="checkbox" id="checkSocio" checked class="checkbox-pro">
                                    <span class="text-sm text-slate-400 group-hover:text-white transition">Nome do S√≥cio</span>
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1">Tipo de Pesquisa</label>
                                <select id="tipoPesquisa" class="input-pro">
                                    <option value="exata">Exata</option>
                                    <option value="radical">Radical</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1">CNPJ Raiz</label>
                                <input type="text" id="cnpjRaiz" maxlength="8" placeholder="Somente os 8 d√≠gitos" class="input-pro">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 2. LOCALIZA√á√ÉO -->
                <section class="bg-slate-800/40 border border-slate-700 rounded-lg p-6 shadow-sm">
                    <div class="mb-4 flex items-center gap-2 border-b border-slate-700/50 pb-2">
                        <i class="fa-solid fa-map-location-dot text-blue-500"></i>
                        <h3 class="text-sm font-bold text-white uppercase">Localiza√ß√£o</h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Estado (UF)</label>
                            <select id="uf" class="input-pro" onchange="loadCities(this.value)">
                                <option value="">Selecione...</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="AP">Amap√°</option>
                                <option value="AM">Amazonas</option>
                                <option value="BA">Bahia</option>
                                <option value="CE">Cear√°</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="ES">Esp√≠rito Santo</option>
                                <option value="GO">Goi√°s</option>
                                <option value="MA">Maranh√£o</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="PA">Par√°</option>
                                <option value="PB">Para√≠ba</option>
                                <option value="PR">Paran√°</option>
                                <option value="PE">Pernambuco</option>
                                <option value="PI">Piau√≠</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="RN">Rio Grande do Norte</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="RO">Rond√¥nia</option>
                                <option value="RR">Roraima</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="SP">S√£o Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                        <div class="relative">
                            <label class="block text-xs font-bold text-slate-400 mb-1">Munic√≠pio</label>
                            <div class="relative">
                                <select id="municipioInput" class="input-pro disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <option value="">Selecione UF primeiro...</option>
                                </select>
                                <div id="cityLoader" class="hidden absolute right-8 top-3 text-blue-500">
                                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                                </div>
                            </div>
                            <p id="cityCount" class="text-[10px] text-slate-500 mt-1 h-3"></p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Bairro</label>
                            <input type="text" id="bairro" placeholder="Digite o bairro" class="input-pro">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">CEP</label>
                            <input type="text" id="cep" placeholder="00000-000" class="input-pro">
                        </div>
                    </div>
                </section>

                <!-- FILTROS -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <section class="bg-slate-800/40 border border-slate-700 rounded-lg p-6 lg:col-span-2">
                        <h3 class="text-sm font-bold text-white uppercase mb-4 border-b border-slate-700/50 pb-2"><i class="fa-solid fa-filter text-blue-500 mr-2"></i> Filtros de Neg√≥cio</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- SITUA√á√ÉO -->
                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-400">Situa√ß√£o</label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="sitAtiva" checked class="checkbox-pro"> <span class="text-xs">Ativa</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="sitBaixada" class="checkbox-pro"> <span class="text-xs">Baixada</span></label>
                            </div>
                            <!-- MEI/SIMPLES -->
                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-400">Regime</label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="swExcludeMei" class="checkbox-pro"> <span class="text-xs">Excluir MEI</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="swOnlySimples" class="checkbox-pro"> <span class="text-xs">Somente Simples</span></label>
                            </div>
                        </div>
                    </section>

                    <section class="bg-slate-800/40 border border-slate-700 rounded-lg p-6 lg:col-span-2">
                        <h3 class="text-sm font-bold text-white uppercase mb-4 border-b border-slate-700/50 pb-2"><i class="fa-solid fa-calendar text-blue-500 mr-2"></i> Per√≠odo e Capital</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1">Abertura</label>
                                <div class="flex gap-2">
                                    <input type="date" id="dataAberturaDe" class="input-pro text-xs p-2">
                                    <input type="date" id="dataAberturaAte" class="input-pro text-xs p-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1">Capital Social</label>
                                <div class="flex gap-2">
                                    <input type="number" id="capitalMin" placeholder="Min" class="input-pro text-xs p-2">
                                    <input type="number" id="capitalMax" placeholder="Max" class="input-pro text-xs p-2">
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- WEBHOOK & A√á√ÉO -->
                <section class="bg-slate-900 border border-slate-700 rounded-lg p-6 shadow-lg">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex-1 w-full space-y-3">
                            <h3 class="text-sm font-bold text-white mb-2"><i class="fa-solid fa-satellite-dish text-emerald-500 mr-2"></i> Webhook (Opcional)</h3>
                            <input type="url" id="webhookUrl" placeholder="https://seu-webhook.com/endpoint" class="input-pro text-xs">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="webhookActive" class="checkbox-pro text-emerald-500">
                                <span class="text-xs text-emerald-400 font-bold">Ativar envio em tempo real</span>
                            </label>
                        </div>
                        <button id="btnHunt" type="submit" class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white font-black py-4 px-12 rounded-lg shadow-xl shadow-blue-900/20 transform hover:-translate-y-1 transition duration-200 flex items-center justify-center gap-3 text-lg group">
                            <span>EXECUTAR CA√áADA</span>
                            <i class="fa-solid fa-rocket group-hover:animate-bounce"></i>
                        </button>
                    </div>
                </section>
            </div>

            <!-- üó∫Ô∏è ABA 2: GOOGLE MAPS (SERPAPI) -->
            <div id="tab-maps" class="tab-content space-y-8 fade-in">
                <section class="bg-slate-800/40 border border-slate-700 rounded-lg p-6 shadow-sm">
                    <div class="mb-6 flex items-center gap-2 border-b border-slate-700/50 pb-2">
                        <i class="fa-solid fa-map text-red-500"></i>
                        <h3 class="text-sm font-bold text-white uppercase">Busca Geogr√°fica (SerpApi)</h3>
                    </div>
                    
                    <!-- üìä RESULTADOS MAPS -->
                    <div class="bg-slate-900 border border-slate-700 rounded-md p-4 mb-6 flex justify-between items-center">
                        <div>
                            <span class="text-[10px] uppercase font-bold text-slate-500 block">Status Maps</span>
                            <span class="text-xs text-slate-400">Pronto para extra√ß√£o</span>
                        </div>
                        <div class="text-right flex gap-6">
                            <div>
                                <span class="text-2xl font-black text-red-500 block leading-none" id="mapsFound">0</span>
                                <span class="text-[10px] text-slate-500 uppercase">Locais</span>
                            </div>
                            <div>
                                <span class="text-2xl font-black text-blue-500 block leading-none" id="mapsSaved">0</span>
                                <span class="text-[10px] text-slate-500 uppercase">Salvos</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Termo de Busca</label>
                            <input type="text" placeholder="Ex: Restaurantes, Escolas, Mec√¢nicas" class="input-pro">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Localiza√ß√£o Central</label>
                            <input type="text" placeholder="Ex: Av. Paulista, 1000 - SP" class="input-pro">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Raio de Busca (Metros)</label>
                            <input type="number" value="1000" class="input-pro">
                        </div>
                        
                        <!-- NOVOS FILTROS -->
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Filtro WhatsApp</label>
                            <select id="filterWhatsapp" class="input-pro">
                                <option value="all">Todos</option>
                                <option value="with_whatsapp">Somente com WhatsApp</option>
                                <option value="without_whatsapp">Somente sem WhatsApp</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Filtro Website</label>
                            <select id="filterWebsite" class="input-pro">
                                <option value="all">Todos</option>
                                <option value="with_website">Somente com Site</option>
                                <option value="without_website">Somente sem Site</option>
                            </select>
                        </div>

                        <div class="flex items-end">
                            <button type="button" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-md transition shadow-md">
                                <i class="fa-solid fa-magnifying-glass-location mr-2"></i> Buscar no Mapa
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- üéØ ABA 3: SNIPER (Placeholder) -->
            <div id="tab-sniper" class="tab-content space-y-8 fade-in">
                <section class="bg-slate-800/40 border border-slate-700 rounded-lg p-6 shadow-sm">
                    <div class="mb-6 flex items-center gap-2 border-b border-slate-700/50 pb-2">
                        <i class="fa-solid fa-crosshairs text-purple-500"></i>
                        <h3 class="text-sm font-bold text-white uppercase">Configura√ß√£o de Disparo</h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        <!-- Configura√ß√£o -->
                        <div class="md:col-span-4 space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1">Canal de Envio</label>
                                <select class="input-pro">
                                    <option>WhatsApp (Evolution API)</option>
                                    <option>E-mail Marketing</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1">Cad√™ncia (Delay)</label>
                                <select class="input-pro">
                                    <option>R√°pido (1 msg/min)</option>
                                    <option selected>Seguro (1 msg a cada 5 min)</option>
                                    <option>Lento (1 msg a cada 15 min)</option>
                                </select>
                            </div>
                            <div class="bg-slate-900 p-4 rounded-md border border-slate-700">
                                <span class="text-xs font-bold text-purple-400 block mb-2">IA Contextual</span>
                                <label class="flex items-center gap-2 cursor-pointer mb-2">
                                    <input type="checkbox" checked class="checkbox-pro">
                                    <span class="text-xs text-slate-300">Ler "Sobre" da empresa</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" checked class="checkbox-pro">
                                    <span class="text-xs text-slate-300">Personalizar com Nome do S√≥cio</span>
                                </label>
                            </div>
                        </div>

                        <!-- Template -->
                        <div class="md:col-span-8">
                            <label class="block text-xs font-bold text-slate-400 mb-1">Template da Mensagem (Prompt IA)</label>
                            <textarea class="w-full h-48 bg-slate-900 border border-slate-700 rounded-md p-3 text-white placeholder-slate-600 focus:border-purple-500 focus:outline-none transition text-sm font-mono" placeholder="Ol√° {primeiro_nome}, vi que a {empresa} atua no ramo de..."></textarea>
                            <div class="mt-4 flex justify-end">
                                <button type="button" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-md transition shadow-md flex items-center gap-2">
                                    <i class="fa-solid fa-play"></i> INICIAR DISPAROS
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- üìä CONSOLE -->
            <div class="bg-black border border-slate-800 rounded-lg p-4 font-mono text-xs h-48 overflow-y-auto shadow-inner mt-8" id="consoleOutput">
                <div class="text-blue-500 mb-1">> System Ready. V5.1 Loaded.</div>
            </div>

        </form>
    </main>

    <script>
        // --- LOGIC V5.1 ---

        // Tab Switching
        function openTab(tabId, btn) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        const log = (msg, type = 'info') => {
            const consoleDiv = document.getElementById('consoleOutput');
            const p = document.createElement('div');
            const color = type === 'error' ? 'text-red-500 font-bold' : (type === 'success' ? 'text-emerald-400' : 'text-slate-400');
            const icon = type === 'error' ? '‚ùå' : (type === 'success' ? '‚úÖ' : '>');
            p.className = `${color} mb-1 border-b border-slate-900/50 pb-1`;
            p.innerHTML = `<span class="opacity-50 mr-2">${new Date().toLocaleTimeString()}</span> ${icon} ${msg}`;
            consoleDiv.appendChild(p);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        // 1. CIDADES (SELECT FIX)
        async function loadCities(state) {
            const cityInput = document.getElementById('municipioInput');
            const loader = document.getElementById('cityLoader');
            const countLabel = document.getElementById('cityCount');
            
            if (!state) {
                cityInput.disabled = true;
                cityInput.innerHTML = '<option value="">Selecione UF primeiro...</option>';
                countLabel.innerText = '';
                return;
            }

            cityInput.disabled = true;
            cityInput.innerHTML = '<option value="">Carregando cidades...</option>';
            loader.classList.remove('hidden');
            log(`Iniciando download de munic√≠pios: ${state}...`, 'info');

            try {
                const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${state}/municipios`);
                if (!response.ok) throw new Error("Falha na API IBGE");
                const cities = await response.json();

                cities.sort((a, b) => a.nome.localeCompare(b.nome));
                
                let optionsHtml = '<option value="">Selecione ou digite...</option>';
                cities.forEach(city => {
                    optionsHtml += `<option value="${city.nome}">${city.nome}</option>`;
                });
                
                cityInput.innerHTML = optionsHtml;
                cityInput.disabled = false;
                countLabel.innerText = `${cities.length} cidades carregadas.`;
                log(`Sucesso: ${cities.length} munic√≠pios de ${state} prontos.`, 'success');

            } catch (error) {
                console.error(error);
                cityInput.innerHTML = '<option value="">Erro ao carregar</option>';
                log(`Erro cr√≠tico ao buscar cidades: ${error.message}`, 'error');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // 2. DIAGN√ìSTICO
        async function testConnection() {
            const url = document.getElementById('kestraUrl').value.replace(/\/$/, "");
            const statusEl = document.getElementById('connectionStatus');
            
            statusEl.className = "text-xs mt-2 h-4 font-mono text-yellow-500";
            statusEl.innerText = "Conectando...";
            log(`Tentando conectar em: ${url}`, 'info');

            try {
                const response = await fetch(`${url}/api/v1/flows`, { 
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.status === 200 || response.status === 401) {
                    statusEl.className = "text-xs mt-2 h-4 font-mono text-emerald-400 font-bold";
                    statusEl.innerText = "ONLINE ‚úÖ";
                    log("Conex√£o estabelecida com sucesso! Servidor Kestra Respondendo.", "success");
                } else {
                    throw new Error(`Status ${response.status}`);
                }
            } catch (error) {
                statusEl.className = "text-xs mt-2 h-4 font-mono text-red-500 font-bold";
                statusEl.innerText = "OFFLINE ‚ùå";
                log(`Falha de Conex√£o: ${error.message}`, "error");
                
                if (error.message.includes("Failed to fetch")) {
                    log("‚ö†Ô∏è DIAGN√ìSTICO: Bloqueio de CORS ou Endere√ßo Inexistente.", "error");
                    log("üëâ Dica: Verifique se o Kestra est√° rodando e se as vari√°veis CORS est√£o configuradas.", "info");
                }
            }
        }

        // 3. EXECU√á√ÉO DO FLUXO
        async function startHunt() {
            const config = getConfig();
            const btn = document.getElementById('btnHunt');
            
            if (!config.url || !config.flowId) {
                toggleConfig();
                return log("Erro: Configure a URL do Kestra na engrenagem.", "error");
            }

            const payload = {
                termo: document.getElementById('termo').value,
                filtros: {
                    checks: {
                        razao: document.getElementById('checkRazao').checked,
                        fantasia: document.getElementById('checkFantasia').checked,
                        socio: document.getElementById('checkSocio').checked
                    },
                    tipo: document.getElementById('tipoPesquisa').value,
                    cnpj: document.getElementById('cnpj').value,
                    uf: document.getElementById('uf').value,
                    municipio: document.getElementById('municipioInput').value,
                    situacao: {
                        ativa: document.getElementById('sitAtiva').checked,
                        baixada: document.getElementById('sitBaixada').checked,
                        inapta: document.getElementById('sitInapta').checked,
                        suspensa: document.getElementById('sitSuspensa').checked
                    },
                    mei: {
                        only: document.getElementById('swOnlyMei').checked,
                        exclude: document.getElementById('swExcludeMei').checked
                    },
                    simples: {
                        only: document.getElementById('swOnlySimples').checked,
                        exclude: document.getElementById('swExcludeSimples').checked
                    },
                    estrutura: {
                        matriz: document.getElementById('swOnlyMatriz').checked,
                        filial: document.getElementById('swOnlyFilial').checked
                    },
                    contato: {
                        email: document.getElementById('comEmail').checked,
                        celular: document.getElementById('soCelular').checked,
                        fixo: document.getElementById('soFixo').checked
                    },
                    datas: {
                        abertura_de: document.getElementById('dataAberturaDe').value,
                        abertura_ate: document.getElementById('dataAberturaAte').value
                    },
                    capital: {
                        min: document.getElementById('capitalMin').value,
                        max: document.getElementById('capitalMax').value
                    },
                    webhook: {
                        url: document.getElementById('webhookUrl').value,
                        active: document.getElementById('webhookActive').checked
                    }
                },
                token_casa_dados: document.getElementById('apiTokenCasaDados').value
            };

            log("Preparando ogiva de dados...", "info");
            
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> ENVIANDO...`;

            const formData = new FormData();
            formData.append('filters_json', JSON.stringify(payload));
            formData.append('termo', payload.termo); 
            formData.append('estado', payload.filtros.uf);
            formData.append('casa_dados_token', config.apiTokenCasaDados || '');

            const endpoint = `${config.url}/api/v1/executions/${config.namespace}/${config.flowId}?wait=true`;

            try {
                const response = await fetch(endpoint, { method: 'POST', body: formData });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`üöÄ Miss√£o Iniciada! ID: ${data.id}`, "success");
                    log(`Link: ${config.url}/ui/executions/${config.namespace}/${config.flowId}/${data.id}`, "info");
                    
                    // Update Dashboard
                    if (data.outputs && data.outputs.count) {
                        document.getElementById('dashSaved').innerText = data.outputs.count;
                        document.getElementById('dashFound').innerText = data.outputs.total_found || data.outputs.count;
                        log(`Relat√≥rio: ${data.outputs.count} empresas salvas.`, "success");
                    }

                } else {
                    const txt = await response.text();
                    log(`Erro Kestra: ${response.status} - ${txt}`, "error");
                }
            } catch (error) {
                log(`Erro Fatal: ${error.message}`, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span>EXECUTAR CA√áADA</span><i class="fa-solid fa-rocket"></i>`;
            }
        }

        // --- CONFIG ---
        function getConfig() {
            return {
                url: document.getElementById('kestraUrl').value.replace(/\/$/, ""),
                namespace: document.getElementById('kestraNamespace').value,
                flowId: document.getElementById('kestraFlowId').value,
                apiTokenCasaDados: document.getElementById('apiTokenCasaDados').value,
                apiTokenSerpApi: document.getElementById('apiTokenSerpApi').value
            };
        }

        function saveConfig() {
            const data = {
                url: document.getElementById('kestraUrl').value,
                namespace: document.getElementById('kestraNamespace').value,
                flowId: document.getElementById('kestraFlowId').value,
                apiTokenCasaDados: document.getElementById('apiTokenCasaDados').value,
                apiTokenSerpApi: document.getElementById('apiTokenSerpApi').value
            };
            localStorage.setItem('biotchelly_config_v5', JSON.stringify(data));
            toggleConfig();
            log("Configura√ß√µes salvas.", "success");
        }

        function loadConfig() {
            const saved = JSON.parse(localStorage.getItem('biotchelly_config_v5') || '{}');
            if (saved.url) document.getElementById('kestraUrl').value = saved.url;
            if (saved.namespace) document.getElementById('kestraNamespace').value = saved.namespace;
            if (saved.flowId) document.getElementById('kestraFlowId').value = saved.flowId;
            if (saved.apiTokenCasaDados) document.getElementById('apiTokenCasaDados').value = saved.apiTokenCasaDados;
            if (saved.apiTokenSerpApi) document.getElementById('apiTokenSerpApi').value = saved.apiTokenSerpApi;
            
            if (!document.getElementById('kestraUrl').value) document.getElementById('kestraUrl').value = "https://kestra.biotchellyprospecta.online";
        }

        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeBtn').querySelector('i');
            html.classList.toggle('light-mode');
            if (html.classList.contains('light-mode')) {
                icon.className = 'fa-solid fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                icon.className = 'fa-solid fa-sun';
                localStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            if (localStorage.getItem('theme') === 'light') toggleTheme();
        }

        function toggleConfig() {
            document.getElementById('configModal').classList.toggle('hidden');
        }

        function clearForm() {
            document.getElementById('hunterForm').reset();
            log("Formul√°rio limpo.", "info");
        }

        window.onload = () => {
            loadConfig();
            loadTheme();
            log("Painel V5.1 Inicializado.");
        };

    </script>
</body>
</html>
