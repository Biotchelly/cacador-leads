<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïµÔ∏è Command Center V5.3 | Biotchelly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#151e2e',
                        },
                        brand: {
                            500: '#6366f1', // Indigo
                            600: '#4f46e5',
                        }
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                        'mesh': 'radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%)',
                        'mesh-light': 'radial-gradient(at 0% 0%, hsla(253,16%,90%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,90%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,90%,1) 0, transparent 50%)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-display {
            font-family: 'Outfit', sans-serif;
        }

        .glass-panel {
            @apply bg-white/70 dark:bg-slate-900/60 backdrop-blur-xl border border-white/20 dark:border-white/5 shadow-xl;
        }

        /* Asymmetric Corners */
        .corner-asym-1 {
            border-radius: 1.5rem 0.5rem 1.5rem 1.5rem;
        }

        .corner-asym-2 {
            border-radius: 0.5rem 1.5rem 1.5rem 1.5rem;
        }

        .corner-asym-3 {
            border-radius: 1.5rem 1.5rem 0.5rem 1.5rem;
        }

        .corner-asym-4 {
            border-radius: 1.5rem 1.5rem 1.5rem 0.5rem;
        }

        /* Dynamic Float Animation */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-5px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .input-pro {
            @apply w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-md p-3 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition text-sm shadow-sm dark:shadow-inner;
        }

        .checkbox-pro {
            @apply w-4 h-4 text-blue-600 bg-slate-800 border-slate-600 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        .tab-btn {
            @apply px-6 py-3 font-bold text-sm uppercase tracking-wide border-b-2 border-transparent transition-all duration-200 text-slate-500 hover:text-white cursor-pointer;
        }

        .tab-btn.active {
            @apply border-blue-500 text-blue-600 dark:text-blue-400 bg-slate-200 dark:bg-slate-800/50 rounded-t-lg;
        }

        .tab-content {
            @apply hidden;
        }

        .tab-content.active {
            @apply block fade-in;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        .btn-jobs {
            @apply bg-blue-600 hover:bg-blue-500 text-slate-200 shadow-md transition transform hover:-translate-y-0.5 font-bold;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #475569;
            transition: .4s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: #a855f7;
        }

        input:checked+.toggle-slider:before {
            transform: translateX(28px);
        }
    </style>
</head>

<body
    class="antialiased min-h-screen p-4 md:p-8 bg-slate-50 dark:bg-slate-950 bg-mesh-light dark:bg-mesh bg-fixed text-slate-800 dark:text-slate-200 transition-colors duration-500 selection:bg-brand-500 selection:text-white">
    <script>
        // Apply theme immediately to avoid flash
        const theme = localStorage.getItem('theme') || 'system';
        if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <!-- CONFIG MODAL -->
    <div id="configModal"
        class="hidden fixed inset-0 bg-black/50 dark:bg-black/90 z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-white dark:bg-slate-900 p-8 rounded-xl border border-slate-200 dark:border-slate-600 w-full max-w-lg shadow-2xl">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
                <i class="fa-solid fa-cogs text-blue-500"></i> Configura√ß√£o do Motor
            </h2>

            <div class="space-y-5">
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-400 mb-1">URL do Webhook (Backend
                        V5.2)</label>
                    <input type="text" id="kestraWebhookUrl"
                        placeholder="https://kestra.../api/v1/executions/webhook/biotchellymcp/biotchelly_command_center_v51"
                        class="input-pro font-mono text-xs">
                    <p class="text-[10px] text-slate-500 mt-1">Copie a URL do trigger 'webhook_frontend' do flow
                        09_command_center_backend</p>
                </div>

                <div class="space-y-3 pt-2 border-t border-slate-700">
                    <div>
                        <label class="block text-xs uppercase font-bold text-emerald-500 mb-1">Token Casa dos
                            Dados</label>
                        <input type="password" id="apiTokenCasaDados" placeholder="Cole seu token aqui"
                            class="input-pro border-emerald-900 focus:border-emerald-500">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-red-500 mb-1">Token SerpApi (Google
                            Maps)</label>
                        <input type="password" id="apiTokenSerpApi" placeholder="Cole sua chave SerpApi"
                            class="input-pro border-red-900 focus:border-red-500">
                    </div>
                    <div>
                        <label
                            class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                            <input type="checkbox" id="useProxy" class="checkbox-pro">
                            <span class="text-xs font-bold text-slate-600 dark:text-slate-300">
                                <i class="fa-solid fa-shield-halved text-orange-500 mr-1"></i>
                                Ativar Proxy (Bypass CORS)
                            </span>
                        </label>
                        <p class="text-[10px] text-slate-500 ml-7">Ative se estiver enfrentando erros de conex√£o ou
                            CORS.</p>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3 pt-4 border-t border-slate-700">
                <button onclick="toggleConfig()"
                    class="px-4 py-2 text-slate-400 hover:text-white font-bold transition">Cancelar</button>
                <button onclick="saveConfig()"
                    class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded font-bold shadow-lg transition">Salvar
                    Configura√ß√£o</button>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <main class="w-full max-w-7xl mx-auto space-y-6">

        <!-- HEADER -->
        <div
            class="glass-panel p-6 rounded-3xl flex flex-col md:flex-row items-center justify-between gap-6 relative overflow-hidden group">
            <div
                class="absolute inset-0 bg-gradient-to-r from-blue-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition duration-500 pointer-events-none">
            </div>

            <div class="flex items-center gap-5 relative z-10">
                <div
                    class="w-16 h-16 flex items-center justify-center bg-slate-900 dark:bg-black rounded-2xl border border-slate-700 shadow-2xl transform rotate-3 hover:rotate-0 transition duration-300">
                    <i class="fa-solid fa-crosshairs text-blue-500 text-3xl animate-pulse"></i>
                </div>
                <div>
                    <h1
                        class="text-4xl md:text-5xl font-black text-slate-900 dark:text-white tracking-tighter font-display">
                        COMMAND <span
                            class="text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-600">CENTER</span>
                    </h1>
                    <div class="flex items-center gap-3">
                        <span
                            class="px-2 py-0.5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-[10px] font-black uppercase tracking-widest border border-blue-200 dark:border-blue-800">V5.3</span>
                        <p
                            class="text-slate-500 dark:text-slate-400 text-xs font-mono font-bold uppercase tracking-widest">
                            Biotchelly Intelligence</p>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 items-center relative z-10">
                <!-- Theme Switcher -->
                <div
                    class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-1.5 flex gap-1 mr-2 shadow-sm">
                    <button onclick="setTheme('light')"
                        class="w-10 h-10 rounded-md flex items-center justify-center text-slate-500 hover:text-orange-500 hover:bg-orange-50 dark:hover:bg-slate-700 transition"
                        title="Claro"><i class="fa-solid fa-sun text-lg"></i></button>
                    <button onclick="setTheme('dark')"
                        class="w-10 h-10 rounded-md flex items-center justify-center text-slate-500 hover:text-blue-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition"
                        title="Escuro"><i class="fa-solid fa-moon text-lg"></i></button>
                    <button onclick="setTheme('system')"
                        class="w-10 h-10 rounded-md flex items-center justify-center text-slate-500 hover:text-purple-500 hover:bg-purple-50 dark:hover:bg-slate-700 transition"
                        title="Sistema"><i class="fa-solid fa-laptop text-lg"></i></button>
                </div>

                <button onclick="clearForm()"
                    class="px-4 py-2 btn-jobs rounded-md text-xs uppercase flex items-center gap-2">
                    <i class="fa-solid fa-eraser"></i> Limpar
                </button>
                <button onclick="toggleConfig()"
                    class="px-4 py-2 btn-jobs rounded-md flex items-center gap-2 text-xs uppercase">
                    <i class="fa-solid fa-gear"></i> Configurar
                </button>
            </div>
        </div>

        <!-- TABS -->
        <div class="flex justify-center mb-8">
            <div class="glass-panel p-1.5 rounded-full inline-flex gap-2 relative z-10">
                <button
                    class="px-6 py-2.5 rounded-full font-bold text-sm uppercase tracking-wide transition-all duration-300 text-slate-500 hover:text-slate-900 dark:hover:text-white cursor-pointer tab-btn active"
                    onclick="openTab('tab-cacador', this)">
                    <i class="fa-solid fa-database mr-2"></i> Ca√ßador
                </button>
                <button
                    class="px-6 py-2.5 rounded-full font-bold text-sm uppercase tracking-wide transition-all duration-300 text-slate-500 hover:text-slate-900 dark:hover:text-white cursor-pointer tab-btn"
                    onclick="openTab('tab-maps', this)">
                    <i class="fa-solid fa-map-location-dot mr-2"></i> Maps
                </button>
                <button
                    class="px-6 py-2.5 rounded-full font-bold text-sm uppercase tracking-wide transition-all duration-300 text-slate-500 hover:text-slate-900 dark:hover:text-white cursor-pointer tab-btn"
                    onclick="openTab('tab-sniper', this)">
                    <i class="fa-solid fa-bullseye mr-2"></i> Sniper
                </button>
            </div>
        </div>

        <style>
            .tab-btn.active {
                @apply bg-slate-900 dark:bg-blue-600 text-white shadow-lg transform scale-105;
                border: none !important;
                /* Override default */
            }
        </style>

        <form id="hunterForm" onsubmit="event.preventDefault(); startHunt();">

            <!-- ABA 1: CA√áADOR (BENTO GRID) -->
            <div id="tab-cacador" class="tab-content active fade-in">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6 auto-rows-min">

                    <!-- Identifica√ß√£o (Big Block) -->
                    <section class="md:col-span-12 glass-panel p-6 md:p-8 corner-asym-1 relative overflow-hidden group">
                        <div
                            class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition duration-500 pointer-events-none">
                            <i class="fa-solid fa-fingerprint text-9xl"></i>
                        </div>

                        <div class="mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-magnifying-glass text-blue-500 text-xl"></i>
                            <h3
                                class="text-xl font-black text-slate-800 dark:text-white uppercase font-display tracking-tight">
                                Identifica√ß√£o do Alvo</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 relative z-10">
                            <div class="md:col-span-8">
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wider">CNPJ
                                    Alvo</label>
                                <input type="text" id="cnpj" placeholder="Ex: 33.000.167/0001-01"
                                    class="input-pro font-mono text-lg font-bold">
                            </div>

                            <div class="md:col-span-4 grid grid-cols-2 gap-2">
                                <div
                                    class="glass-panel bg-emerald-500/10 border-emerald-500/20 p-3 rounded-2xl flex flex-col justify-center items-center">
                                    <span class="text-2xl font-black text-emerald-500 font-display"
                                        id="dashFound">0</span>
                                    <span
                                        class="text-[10px] uppercase font-bold text-emerald-700 dark:text-emerald-300">Encontradas</span>
                                </div>
                                <div
                                    class="glass-panel bg-blue-500/10 border-blue-500/20 p-3 rounded-2xl flex flex-col justify-center items-center">
                                    <span class="text-2xl font-black text-blue-500 font-display" id="dashSaved">0</span>
                                    <span
                                        class="text-[10px] uppercase font-bold text-blue-700 dark:text-blue-300">Salvas</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Busca Textual & Op√ß√µes (Full Width) -->
                    <section class="md:col-span-12 glass-panel p-6 md:p-8 corner-asym-2">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                            <div class="md:col-span-6">
                                <div class="mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-pen-nib text-purple-500"></i>
                                    <h3 class="text-sm font-bold text-slate-800 dark:text-white uppercase font-display">
                                        Busca Textual</h3>
                                </div>
                                <input type="text" id="termo" placeholder="Termo (Ex: Padaria)"
                                    class="input-pro text-xl font-bold mb-4">
                            </div>

                            <div class="md:col-span-3">
                                <label
                                    class="block text-xs font-bold text-slate-400 mb-3 uppercase tracking-widest">Buscar
                                    em</label>
                                <div class="space-y-3">
                                    <label
                                        class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition cursor-pointer">
                                        <input type="checkbox" id="checkRazao" checked class="checkbox-pro">
                                        <span class="text-sm font-bold text-slate-600 dark:text-slate-300">Raz√£o
                                            Social</span>
                                    </label>
                                    <label
                                        class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition cursor-pointer">
                                        <input type="checkbox" id="checkFantasia" checked class="checkbox-pro">
                                        <span class="text-sm font-bold text-slate-600 dark:text-slate-300">Nome
                                            Fantasia</span>
                                    </label>
                                    <label
                                        class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition cursor-pointer">
                                        <input type="checkbox" id="checkSocio" checked class="checkbox-pro">
                                        <span class="text-sm font-bold text-slate-600 dark:text-slate-300">Nome do
                                            S√≥cio</span>
                                    </label>
                                </div>
                            </div>

                            <div class="md:col-span-3">
                                <label
                                    class="block text-xs font-bold text-slate-400 mb-3 uppercase tracking-widest">Modo
                                    de Busca</label>
                                <select id="tipoPesquisa" class="input-pro font-mono text-sm">
                                    <option value="exata">Exata (Precisa)</option>
                                    <option value="radical">Radical (Ampla)</option>
                                </select>
                            </div>
                        </div>
                    </section>

                    <!-- Localiza√ß√£o (Wide Strip) -->
                    <section class="md:col-span-12 glass-panel p-6 md:p-8 corner-asym-4">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fa-solid fa-location-dot text-red-500"></i>
                            <h3 class="text-sm font-bold text-slate-800 dark:text-white uppercase font-display">
                                Geografia</h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <select id="uf" class="input-pro" onchange="loadMunicipios()">
                                    <option value="">Selecione o Estado</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amap√°</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Cear√°</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Esp√≠rito Santo</option>
                                    <option value="GO">Goi√°s</option>
                                    <option value="MA">Maranh√£o</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Par√°</option>
                                    <option value="PB">Para√≠ba</option>
                                    <option value="PR">Paran√°</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piau√≠</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rond√¥nia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">S√£o Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                            </div>
                            <div>
                                <select id="municipio" class="input-pro" disabled>
                                    <option value="">Selecione o Munic√≠pio</option>
                                </select>
                            </div>
                            <div><input type="text" id="bairro" class="input-pro" placeholder="Bairro"></div>
                            <div><input type="text" id="cep" class="input-pro" placeholder="CEP"></div>
                        </div>
                    </section>
                    <!-- Detalhes e Filtros (Unified Bento Block) -->
                    <section class="md:col-span-12 glass-panel p-6 md:p-8 corner-asym-3 relative overflow-hidden">
                        <div
                            class="absolute -left-10 -bottom-10 w-64 h-64 bg-blue-500/5 rounded-full blur-3xl pointer-events-none">
                        </div>

                        <div class="flex items-center gap-3 mb-6 relative z-10">
                            <div class="p-2 bg-blue-500/10 rounded-xl"><i
                                    class="fa-solid fa-layer-group text-blue-500 text-xl"></i></div>
                            <h3
                                class="text-lg font-bold text-slate-800 dark:text-white uppercase font-display tracking-tight">
                                Filtros Avan√ßados & Detalhes</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-8 relative z-10">

                            <!-- Coluna 1: Status e Regime -->
                            <div class="space-y-6 border-r border-slate-200 dark:border-slate-700/50 pr-6">
                                <div>
                                    <label
                                        class="block text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">Situa√ß√£o
                                        Cadastral</label>
                                    <div class="flex flex-col gap-3">
                                        <label
                                            class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                            <input type="checkbox" id="sitAtiva" checked class="checkbox-pro">
                                            <span
                                                class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-blue-500 transition">Ativa</span>
                                        </label>
                                        <label
                                            class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                            <input type="checkbox" id="sitBaixada" class="checkbox-pro">
                                            <span
                                                class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-red-500 transition">Baixada</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label
                                        class="block text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">Regime
                                        Tribut√°rio</label>
                                    <div class="flex flex-col gap-3">
                                        <label
                                            class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                            <input type="checkbox" id="swExcludeMei" class="checkbox-pro">
                                            <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Excluir
                                                MEI</span>
                                        </label>
                                        <label
                                            class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                            <input type="checkbox" id="swOnlySimples" class="checkbox-pro">
                                            <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Somente
                                                Simples</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Coluna 2: Datas e Capital -->
                            <div class="space-y-6 border-r border-slate-200 dark:border-slate-700/50 pr-6">
                                <div>
                                    <label
                                        class="block text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">Per√≠odo
                                        de Abertura</label>
                                    <div class="flex items-center gap-2">
                                        <input type="date" id="dataAberturaDe" class="input-pro text-xs py-2">
                                        <span class="text-slate-400 font-bold">at√©</span>
                                        <input type="date" id="dataAberturaAte" class="input-pro text-xs py-2">
                                    </div>
                                </div>
                                <div>
                                    <label
                                        class="block text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">Capital
                                        Social (R$)</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="number" id="capitalMin" placeholder="M√≠nimo"
                                            class="input-pro text-xs py-2">
                                        <input type="number" id="capitalMax" placeholder="M√°ximo"
                                            class="input-pro text-xs py-2">
                                    </div>
                                </div>
                            </div>

                            <!-- Coluna 3: Atividade Econ√¥mica -->
                            <div class="flex flex-col h-full border-r border-slate-200 dark:border-slate-700/50 pr-6">
                                <label
                                    class="block text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">Atividade
                                    Econ√¥mica (CNAE)</label>
                                <div class="flex-grow flex flex-col gap-3">
                                    <textarea id="cnaeInput" placeholder="Digite o c√≥digo ou nome da atividade..."
                                        class="input-pro h-24 resize-none text-sm leading-relaxed"
                                        spellcheck="false"></textarea>
                                    <label
                                        class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition mt-auto">
                                        <input type="checkbox" id="cnaeSecundario" class="checkbox-pro">
                                        <span
                                            class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-purple-500 transition">Incluir
                                            Atividade Secund√°ria</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Coluna 4: Filtros de Contato -->
                            <div class="flex flex-col h-full">
                                <label
                                    class="block text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">Filtros
                                    de Contato</label>
                                <div class="flex-grow flex flex-col gap-3">
                                    <label
                                        class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                        <input type="checkbox" id="filterTelefone" class="checkbox-pro">
                                        <span
                                            class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-green-500 transition">Com
                                            contato de telefone</span>
                                    </label>
                                    <label
                                        class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                        <input type="checkbox" id="filterFixo" class="checkbox-pro">
                                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Somente
                                            fixo</span>
                                    </label>
                                    <label
                                        class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                        <input type="checkbox" id="filterCelular" class="checkbox-pro">
                                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Somente
                                            celular</span>
                                    </label>
                                    <label
                                        class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                        <input type="checkbox" id="filterEmail" class="checkbox-pro">
                                        <span
                                            class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-blue-500 transition">Com
                                            e-mail</span>
                                    </label>
                                </div>
                            </div>

                        </div>
                    </section>

                    <!-- Action Card (Bento Style) -->
                    <section
                        class="md:col-span-12 glass-panel p-6 md:p-8 corner-asym-4 flex flex-col md:flex-row items-center justify-between gap-6 relative overflow-visible group">
                        <div
                            class="absolute inset-0 bg-blue-600/5 opacity-0 group-hover:opacity-100 transition duration-500 pointer-events-none">
                        </div>

                        <div class="flex flex-col gap-2 relative z-10">
                            <h3
                                class="text-lg font-bold text-slate-800 dark:text-white uppercase font-display flex items-center gap-2">
                                <i class="fa-solid fa-rocket text-blue-500"></i> A√ß√µes
                            </h3>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-wider">Confira os filtros
                                acima antes de executar.</p>
                        </div>

                        <div class="flex flex-wrap gap-3 relative z-10">
                            <!-- Bot√£o Pesquisar -->
                            <button id="btnHunt" type="button" onclick="startHunt()"
                                class="bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 text-white font-black py-3 px-8 rounded-xl shadow-xl hover:shadow-emerald-500/30 transform hover:-translate-y-1 transition duration-200 flex items-center justify-center gap-2 text-sm tracking-wider border border-white/10">
                                <i class="fa-solid fa-magnifying-glass"></i>
                                <span>PESQUISAR</span>
                            </button>

                            <!-- Bot√£o Exportar -->
                            <button onclick="exportResults()" type="button"
                                class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-black py-3 px-8 rounded-xl shadow-xl hover:shadow-blue-500/30 transform hover:-translate-y-1 transition duration-200 flex items-center justify-center gap-2 text-sm tracking-wider border border-white/10">
                                <i class="fa-solid fa-download"></i>
                                <span>EXPORTAR RESULTADO</span>
                            </button>

                            <!-- Dropdown Mais Op√ß√µes -->
                            <div class="relative">
                                <button onclick="toggleMoreOptions()" type="button" id="btnMoreOptions"
                                    class="bg-slate-600 hover:bg-slate-500 text-white font-black py-3 px-6 rounded-xl shadow-xl hover:shadow-slate-500/30 transform hover:-translate-y-1 transition duration-200 flex items-center justify-center gap-2 text-sm tracking-wider border border-white/10">
                                    <span>MAIS OP√á√ïES</span>
                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                </button>

                                <!-- Dropdown Menu -->
                                <div id="moreOptionsMenu"
                                    class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden z-50">
                                    <button onclick="checkBalance()" type="button"
                                        class="w-full text-left px-4 py-3 hover:bg-slate-100 dark:hover:bg-slate-700 transition flex items-center gap-3 text-slate-700 dark:text-slate-200">
                                        <i class="fa-solid fa-wallet text-emerald-500"></i>
                                        <span class="font-bold text-sm">Consultar Saldo</span>
                                    </button>
                                    <button onclick="viewGeneratedFiles()" type="button"
                                        class="w-full text-left px-4 py-3 hover:bg-slate-100 dark:hover:bg-slate-700 transition flex items-center gap-3 text-slate-700 dark:text-slate-200 border-t border-slate-200 dark:border-slate-700">
                                        <i class="fa-solid fa-folder-open text-blue-500"></i>
                                        <span class="font-bold text-sm">Visualizar Arquivos Gerados</span>
                                    </button>
                                    <button onclick="saveSearch()" type="button"
                                        class="w-full text-left px-4 py-3 hover:bg-slate-100 dark:hover:bg-slate-700 transition flex items-center gap-3 text-slate-700 dark:text-slate-200 border-t border-slate-200 dark:border-slate-700">
                                        <i class="fa-solid fa-bookmark text-purple-500"></i>
                                        <span class="font-bold text-sm">Salvar Pesquisa</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden Inputs (Compatibilidade) -->
                        <div class="hidden">
                            <input type="text" id="cnpjRaiz"> <!-- Mantido pois n√£o est√° na UI -->
                        </div>
                    </section>
                </div> <!-- End Grid -->
            </div>

            <!-- ABA 2: GOOGLE MAPS -->
            <div id="tab-maps" class="tab-content space-y-8 fade-in">
                <section class="glass-panel p-6 md:p-8 corner-asym-3 relative overflow-hidden">
                    <div
                        class="absolute -right-10 -bottom-10 w-64 h-64 bg-red-500/10 rounded-full blur-3xl pointer-events-none">
                    </div>

                    <div
                        class="mb-6 flex items-center gap-3 border-b border-slate-200 dark:border-slate-700/50 pb-4 relative z-10">
                        <i class="fa-solid fa-map-location-dot text-red-500 text-2xl animate-bounce"></i>
                        <h3
                            class="text-xl font-black text-slate-800 dark:text-white uppercase font-display tracking-tight">
                            Busca Geogr√°fica (SerpApi)</h3>
                    </div>

                    <div
                        class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-md p-4 mb-6 flex justify-between items-center">
                        <div>
                            <span class="text-[10px] uppercase font-bold text-slate-500 block">Status Maps</span>
                            <span class="text-xs text-slate-400">Pronto para extra√ß√£o</span>
                        </div>
                        <div class="text-right flex gap-6">
                            <div>
                                <span class="text-2xl font-black text-red-500 block leading-none"
                                    id="mapsFound">0</span>
                                <span class="text-[10px] text-slate-500 uppercase">Locais</span>
                            </div>
                            <div>
                                <span class="text-2xl font-black text-blue-500 block leading-none"
                                    id="mapsSaved">0</span>
                                <span class="text-[10px] text-slate-500 uppercase">Salvos</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Termo de Busca</label>
                            <input type="text" id="mapsTermo" placeholder="Ex: Restaurantes, Escolas, Mec√¢nicas"
                                class="input-pro">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Localiza√ß√£o Central</label>
                            <input type="text" id="mapsLocation" placeholder="Ex: @-23.550520,-46.633308,15z"
                                class="input-pro">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Raio de Busca (Metros)</label>
                            <input type="number" id="mapsRadius" value="1000" class="input-pro">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Filtro WhatsApp</label>
                            <select id="filterWhatsapp" class="input-pro">
                                <option value="all">Todos</option>
                                <option value="with_whatsapp">Somente com WhatsApp</option>
                                <option value="without_whatsapp">Somente sem WhatsApp</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">Filtro Website</label>
                            <select id="filterWebsite" class="input-pro">
                                <option value="all">Todos</option>
                                <option value="with_website">Somente com Site</option>
                                <option value="without_website">Somente sem Site</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button type="button" onclick="startHunt()"
                                class="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white font-black py-4 rounded-xl transition shadow-xl hover:shadow-red-500/30 transform hover:-translate-y-1 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-magnifying-glass-location fa-lg"></i>
                                <span class="tracking-wider">BUSCAR NO MAPA</span>
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- ABA 3: SNIPER -->
            <div id="tab-sniper" class="tab-content space-y-8 fade-in">
                <!-- Toggle ON/OFF -->
                <section
                    class="glass-panel p-6 md:p-8 corner-asym-4 relative overflow-hidden flex items-center justify-between group">
                    <div
                        class="absolute inset-0 bg-purple-500/5 opacity-0 group-hover:opacity-100 transition duration-500 pointer-events-none">
                    </div>

                    <div>
                        <h3
                            class="text-2xl font-black text-slate-800 dark:text-white mb-1 font-display tracking-tight flex items-center gap-3">
                            <i class="fa-solid fa-crosshairs text-purple-500 animate-pulse"></i>
                            STATUS DO SNIPER
                        </h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest">
                            Controle de Disparo Automatizado</p>
                    </div>

                    <div class="flex items-center gap-6 relative z-10">
                        <span id="sniperStatusText"
                            class="text-xl font-black text-red-500 font-mono tracking-widest">OFFLINE</span>
                        <label class="toggle-switch transform scale-125">
                            <input type="checkbox" id="sniperToggle" onchange="toggleSniper(this)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </section>

                <!-- Configura√ß√£o -->
                <section class="glass-panel p-6 md:p-8 corner-asym-1">
                    <h3 class="text-sm font-bold text-slate-800 dark:text-white uppercase mb-6 flex items-center gap-2">
                        <div class="p-2 bg-purple-500/10 rounded-lg"><i class="fa-solid fa-sliders text-purple-500"></i>
                        </div>
                        Configura√ß√£o de Disparo
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1 uppercase">Cad√™ncia
                                (Delay)</label>
                            <select id="sniperCadence" class="input-pro font-bold">
                                <option value="fast">üöÄ R√°pido (1 msg/min)</option>
                                <option value="safe" selected>üõ°Ô∏è Seguro (1 msg a cada 5 min)</option>
                                <option value="slow">üê¢ Lento (1 msg a cada 15 min)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1 uppercase">Hor√°rio
                                Comercial</label>
                            <label class="flex items-center gap-3 mt-2 cursor-pointer group">
                                <div
                                    class="w-10 h-6 rounded-full border border-slate-600 relative flex items-center transition bg-slate-800 group-hover:border-purple-500">
                                    <input type="checkbox" id="respectBusinessHours" checked
                                        class="opacity-0 absolute inset-0 cursor-pointer w-full h-full z-10">
                                    <div class="w-4 h-4 rounded-full bg-slate-400 ml-1"></div>
                                </div>
                                <span class="text-xs font-bold text-slate-500 dark:text-slate-300">Seg-Sex,
                                    9h-18h</span>
                            </label>
                        </div>
                    </div>

                    <div class="mt-8">
                        <button type="button" onclick="triggerSniper()" id="btnTriggerSniper"
                            class="w-full bg-slate-900 hover:bg-black text-white dark:bg-white dark:text-black dark:hover:bg-slate-200 font-black py-4 rounded-xl transition shadow-lg transform hover:-translate-y-1 flex items-center justify-center gap-3 text-lg tracking-wide border border-slate-800 dark:border-transparent">
                            <i class="fa-solid fa-play"></i>
                            <span>DISPARAR MANUALMENTE</span>
                        </button>
                    </div>
                </section>

                <!-- Estat√≠sticas -->
                <div class="grid grid-cols-3 gap-6">
                    <div
                        class="glass-panel p-5 rounded-3xl flex flex-col items-center justify-center group hover:bg-purple-500/5 transition">
                        <span
                            class="text-4xl font-black text-purple-500 font-display group-hover:scale-110 transition duration-300"
                            id="statMessagesTotal">0</span>
                        <span
                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-2">Enviadas</span>
                    </div>
                    <div
                        class="glass-panel p-5 rounded-3xl flex flex-col items-center justify-center group hover:bg-emerald-500/5 transition">
                        <span
                            class="text-4xl font-black text-emerald-500 font-display group-hover:scale-110 transition duration-300"
                            id="statMessagesToday">0</span>
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-2">Hoje</span>
                    </div>
                    <div
                        class="glass-panel p-5 rounded-3xl flex flex-col items-center justify-center group hover:bg-blue-500/5 transition">
                        <span
                            class="text-4xl font-black text-blue-500 font-display group-hover:scale-110 transition duration-300"
                            id="statPending">0</span>
                        <span
                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-2">Pendentes</span>
                    </div>
                </div>
            </div>

            <!-- CONSOLE -->
            <div class="glass-panel bg-black/90 dark:bg-black/80 rounded-3xl p-6 font-mono text-xs h-48 overflow-y-auto shadow-2xl mt-8 border-t-2 border-slate-800 relative"
                id="consoleOutput">
                <div
                    class="absolute top-2 right-4 text-[10px] text-slate-600 font-bold uppercase tracking-widest pointer-events-none">
                    Terminal Output</div>
                <div class="text-blue-400 mb-1 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                    > System Ready. V5.3 Asymmetric Core Loaded.
                </div>
            </div>

        </form>
    </main>

    <script>
        // --- LOGIC V5.2 (BACKEND INTEGRATION) ---

        let sniperActive = false;
        let sniperInterval = null;

        // Theme Logic
        function setTheme(mode) {
            localStorage.setItem('theme', mode);
            if (mode === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (mode === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                localStorage.removeItem('theme');
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
            log(`üé® Tema alterado para: ${mode}`, 'info');
        }

        // Tab Switching
        function openTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        // Load Municipalities based on selected state
        async function loadMunicipios() {
            const ufSelect = document.getElementById('uf');
            const municipioSelect = document.getElementById('municipio');
            const uf = ufSelect.value;

            // Reset and disable municipality select
            municipioSelect.innerHTML = '<option value="">Carregando...</option>';
            municipioSelect.disabled = true;

            if (!uf) {
                municipioSelect.innerHTML = '<option value="">Selecione o Munic√≠pio</option>';
                return;
            }

            try {
                const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`);
                const municipios = await response.json();

                municipioSelect.innerHTML = '<option value="">Selecione o Munic√≠pio</option>';
                municipios.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.nome;
                    option.textContent = m.nome;
                    municipioSelect.appendChild(option);
                });

                municipioSelect.disabled = false;
                log(`‚úÖ ${municipios.length} munic√≠pios carregados para ${uf}`, 'success');
            } catch (error) {
                municipioSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                log(`‚ùå Erro ao carregar munic√≠pios: ${error.message}`, 'error');
            }
        }

        const log = (msg, type = 'info') => {
            const consoleDiv = document.getElementById('consoleOutput');
            const p = document.createElement('div');
            const color = type === 'error' ? 'text-red-500 font-bold' : (type === 'success' ? 'text-emerald-400' : 'text-slate-500 dark:text-slate-400');
            const icon = type === 'error' ? '‚ùå' : (type === 'success' ? '‚úÖ' : '>');
            p.className = `${color} mb-1 border-b border-slate-800/50 dark:border-slate-900/50 pb-1`;
            p.innerHTML = `<span class="opacity-50 mr-2">${new Date().toLocaleTimeString()}</span> ${icon} ${msg}`;
            consoleDiv.appendChild(p);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        // EXECU√á√ÉO PRINCIPAL
        async function startHunt() {
            const config = getConfig();
            const btn = document.getElementById('btnHunt');

            const activeTab = document.querySelector('.tab-content.active').id;
            let payload = {};

            if (!config.webhookUrl) {
                toggleConfig();
                return log("Erro: Configure a URL do Webhook na engrenagem.", "error");
            }

            // MODO: CA√áADA VIA CASA DOS DADOS
            if (activeTab === 'tab-cacador') {
                const termo = document.getElementById('termo').value;
                if (!termo) return log("Erro: Preencha o Termo de Busca.", "error");

                // Check balance before executing search
                try {
                    const fetchUrl = config.useProxy ?
                        `https://corsproxy.io/?${encodeURIComponent(config.webhookUrl)}` :
                        config.webhookUrl;

                    const balanceCheck = await fetch(fetchUrl, {
                        method: 'POST',
                        // mode: 'cors', // Removed forced mode to compatibility
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            operation_mode: "CHECK_BALANCE",
                            frontend_payload: {
                                token_casa_dados: config.apiTokenCasaDados
                            }
                        })
                    });

                    if (balanceCheck.ok) {
                        const balanceData = await balanceCheck.json();
                        const saldo = balanceData.saldo || 0;

                        if (saldo <= 0) {
                            log("‚ùå SALDO INSUFICIENTE!", "error");
                            log(`   Saldo atual: ${saldo} cr√©ditos`, "error");
                            log("   Recarregue sua conta na Casa dos Dados para continuar.", "error");
                            return;
                        }

                        log(`‚úÖ Saldo dispon√≠vel: ${saldo} cr√©ditos`, "success");
                    }
                } catch (error) {
                    log("‚ö†Ô∏è N√£o foi poss√≠vel verificar saldo. Continuando...", "info");
                }

                payload = {
                    operation_mode: "SEARCH_ONLY",  // Changed from HUNT_CASADADOS
                    frontend_payload: {
                        token_casa_dados: config.apiTokenCasaDados,
                        filters: {
                            cnpj: document.getElementById('cnpj').value,
                            termo: termo,
                            checks: {
                                razao: document.getElementById('checkRazao').checked,
                                fantasia: document.getElementById('checkFantasia').checked,
                                socio: document.getElementById('checkSocio').checked
                            },
                            tipo: document.getElementById('tipoPesquisa').value,
                            cnpj_raiz: document.getElementById('cnpjRaiz').value,
                            uf: document.getElementById('uf').value,
                            municipio: document.getElementById('municipio').value,
                            bairro: document.getElementById('bairro').value,
                            cep: document.getElementById('cep').value,
                            situacao: {
                                ativa: document.getElementById('sitAtiva').checked,
                                baixada: document.getElementById('sitBaixada').checked
                            },
                            mei: {
                                exclude: document.getElementById('swExcludeMei').checked
                            },
                            simples: {
                                only: document.getElementById('swOnlySimples').checked
                            },
                            datas: {
                                abertura_de: document.getElementById('dataAberturaDe').value,
                                abertura_ate: document.getElementById('dataAberturaAte').value
                            },
                            capital: {
                                min: document.getElementById('capitalMin').value,
                                max: document.getElementById('capitalMax').value
                            },
                            cnae: {
                                codigo_nome: document.getElementById('cnaeInput').value,
                                incluir_secundaria: document.getElementById('cnaeSecundario').checked
                            },
                            contato: {
                                tem_telefone: document.getElementById('filterTelefone').checked,
                                somente_fixo: document.getElementById('filterFixo').checked,
                                somente_celular: document.getElementById('filterCelular').checked,
                                tem_email: document.getElementById('filterEmail').checked
                            }
                        }
                    }
                };
            }
            // MODO: CA√áADA VIA GOOGLE MAPS
            else if (activeTab === 'tab-maps') {
                const termo = document.getElementById('mapsTermo').value;
                if (!termo) return log("Erro: Preencha o Termo de Busca no Maps.", "error");

                payload = {
                    operation_mode: "HUNT_MAPS",
                    frontend_payload: {
                        token_serpapi: config.apiTokenSerpApi,
                        filters: {
                            termo: termo,
                            localizacao: document.getElementById('mapsLocation').value,
                            radius: document.getElementById('mapsRadius').value,
                            whatsapp_filter: document.getElementById('filterWhatsapp').value,
                            website_filter: document.getElementById('filterWebsite').value
                        }
                    }
                };
            }

            // DEBUG: Log completo
            console.group('üîç DEBUG - Webhook Request');
            console.log('URL:', config.webhookUrl);
            console.log('Modo:', payload.operation_mode);
            console.log('Payload:', JSON.stringify(payload, null, 2));
            console.groupEnd();

            log(`üì° Pesquisando...`, "info");
            log(`   Modo: ${payload.operation_mode}`, "info");

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> PESQUISANDO...`;
            }

            try {
                const fetchUrl = config.useProxy ?
                    `https://corsproxy.io/?${encodeURIComponent(config.webhookUrl)}` :
                    config.webhookUrl;

                log(`üì° Conectando via ${config.useProxy ? 'Proxy' : 'Direct'}...`, "info");

                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    // mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('üì® Response Status:', response.status);
                console.log('üì® Response OK:', response.ok);

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Response Data:', data);

                    log(`‚úÖ Pesquisa conclu√≠da!`, "success");

                    // Update ENCONTRADAS counter with real results
                    const found = data.found || 0;
                    document.getElementById('dashFound').textContent = found;
                    log(`   üìä ${found} empresas encontradas`, "success");

                    // Store results for later export
                    window.lastSearchResults = data;
                } else {
                    const txt = await response.text();
                    console.error('‚ùå Error Response:', txt);

                    log(`‚ùå Erro HTTP ${response.status}`, "error");
                    log(`   ${txt.substring(0, 150)}`, "error");
                }
            } catch (error) {
                console.error('‚ùå Fetch Error:', error);

                log(`‚ùå Erro de conex√£o: ${error.message}`, "error");

                if (error.message.includes('CORS')) {
                    log(`   üí° Problema de CORS detectado`, "error");
                } else if (error.message.includes('Failed to fetch')) {
                    log(`   üí° Verificar se Kestra est√° online`, "error");
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fa-solid fa-magnifying-glass"></i> <span>PESQUISAR</span>`;
                }
            }
        }

        // SNIPER TOGGLE
        function toggleSniper(checkbox) {
            sniperActive = checkbox.checked;
            const statusText = document.getElementById('sniperStatusText');

            if (sniperActive) {
                statusText.textContent = 'LIGADO';
                statusText.className = 'text-sm font-bold text-emerald-500';
                log('üéØ SNIPER ATIVADO - Modo autom√°tico', 'success');

                // Inicia polling a cada 30 segundos
                sniperInterval = setInterval(triggerSniper, 30000);
            } else {
                statusText.textContent = 'DESLIGADO';
                statusText.className = 'text-sm font-bold text-red-500';
                log('‚è∏Ô∏è SNIPER DESATIVADO', 'info');

                if (sniperInterval) {
                    clearInterval(sniperInterval);
                    sniperInterval = null;
                }
            }
        }

        // TRIGGER SNIPER (Manual ou Autom√°tico)
        async function triggerSniper() {
            const config = getConfig();

            if (!config.webhookUrl) {
                return log("Erro: Configure o webhook primeiro.", "error");
            }

            const payload = {
                operation_mode: "SNIPE",
                frontend_payload: {
                    sniper_config: {
                        cadence: document.getElementById('sniperCadence').value,
                        respect_business_hours: document.getElementById('respectBusinessHours').checked
                    }
                }
            };

            console.log('üéØ Sniper Payload:', JSON.stringify(payload, null, 2));
            log('üéØ Disparando Sniper...', 'info');

            try {
                const fetchUrl = config.useProxy ?
                    `https://corsproxy.io/?${encodeURIComponent(config.webhookUrl)}` :
                    config.webhookUrl;

                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Sniper Response:', data);
                    log(`‚úÖ Sniper executado! ID: ${data.id}`, 'success');
                } else {
                    const txt = await response.text();
                    console.error('‚ùå Sniper Error:', txt);
                    log(`‚ùå Erro no Sniper: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // CONFIG & UTILS
        function getConfig() {
            return {
                webhookUrl: document.getElementById('kestraWebhookUrl').value.replace(/\/$/, ""),
                apiTokenCasaDados: document.getElementById('apiTokenCasaDados').value,
                apiTokenSerpApi: document.getElementById('apiTokenSerpApi').value,
                useProxy: document.getElementById('useProxy').checked
            };
        }

        function saveConfig() {
            const data = {
                webhookUrl: document.getElementById('kestraWebhookUrl').value,
                apiTokenCasaDados: document.getElementById('apiTokenCasaDados').value,
                apiTokenSerpApi: document.getElementById('apiTokenSerpApi').value,
                useProxy: document.getElementById('useProxy').checked
            };
            localStorage.setItem('biotchelly_config_v52', JSON.stringify(data));
            toggleConfig();
            log("Configura√ß√µes salvas.", "success");
        }

        function loadConfig() {
            const saved = JSON.parse(localStorage.getItem('biotchelly_config_v52') || '{}');
            if (saved.webhookUrl) document.getElementById('kestraWebhookUrl').value = saved.webhookUrl;
            if (saved.apiTokenCasaDados) document.getElementById('apiTokenCasaDados').value = saved.apiTokenCasaDados;
            if (saved.apiTokenSerpApi) document.getElementById('apiTokenSerpApi').value = saved.apiTokenSerpApi;
            if (saved.useProxy !== undefined) document.getElementById('useProxy').checked = saved.useProxy;

            // Set default if not saved (for new users, maybe default true if issues persist?)
            if (saved.useProxy === undefined) document.getElementById('useProxy').checked = true;
        }

        function toggleConfig() {
            document.getElementById('configModal').classList.toggle('hidden');
        }

        function clearForm() {
            document.getElementById('hunterForm').reset();
            log("Formul√°rio limpo.", "info");
        }

        // Dropdown Toggle
        function toggleMoreOptions() {
            const menu = document.getElementById('moreOptionsMenu');
            menu.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const menu = document.getElementById('moreOptionsMenu');
            const btn = document.getElementById('btnMoreOptions');
            if (menu && btn && !menu.contains(event.target) && !btn.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // Export Results
        async function exportResults() {
            const config = getConfig();

            if (!window.lastSearchResults || !window.lastSearchResults.companies) {
                log("‚ùå Execute uma pesquisa primeiro!", "error");
                return;
            }

            if (!config.webhookUrl) {
                log("‚ùå Configure a URL do Webhook primeiro!", "error");
                toggleConfig();
                return;
            }

            log("üì¶ Exportando resultados para NocoDB...", "info");

            try {
                const fetchUrl = config.useProxy ?
                    `https://corsproxy.io/?${encodeURIComponent(config.webhookUrl)}` :
                    config.webhookUrl;

                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    // mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation_mode: "EXPORT_TO_NOCODB",
                        frontend_payload: {
                            companies: window.lastSearchResults.companies
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const saved = data.saved || 0;

                    document.getElementById('dashSaved').textContent = saved;
                    log(`‚úÖ ${saved} empresas salvas no NocoDB!`, "success");
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Erro ao exportar: ${response.status}`, "error");
                    log(`   ${errorText.substring(0, 100)}`, "error");
                }
            } catch (error) {
                log(`‚ùå Erro de conex√£o: ${error.message}`, "error");
            }
        }

        // View Generated Files
        function viewGeneratedFiles() {
            toggleMoreOptions();
            log("üìÅ Visualizando arquivos gerados...", "info");
            log("   Funcionalidade em desenvolvimento", "info");
        }

        // Save Search
        function saveSearch() {
            toggleMoreOptions();
            const searchName = prompt("Nome da pesquisa:");
            if (searchName) {
                // TODO: Salvar configura√ß√£o de pesquisa no localStorage ou backend
                log(`üíæ Pesquisa "${searchName}" salva com sucesso!`, "success");
            }
        }

        // Check Balance
        // Check Balance - Direct API Call (Bypassing Kestra to avoid Async/Auth issues)
        async function checkBalance() {
            toggleMoreOptions();
            const config = getConfig();

            if (!config.apiTokenCasaDados) {
                log("‚ùå Configure o Token da Casa dos Dados primeiro!", "error");
                toggleConfig();
                return;
            }

            log("üîÑ Consultando saldo (Direto na API)...", "info");

            try {
                // Use Direct API V5 via Proxy
                // Note: We use the proxy to bypass CORS on the browser
                const targetUrl = "https://api.casadosdados.com.br/v5/saldo";

                const fetchUrl = config.useProxy ?
                    `https://corsproxy.io/?${encodeURIComponent(targetUrl)}` :
                    targetUrl;

                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': config.apiTokenCasaDados
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    // DEBUG: Verifique a estrutura bruta se necess√°rio
                    log("üîç Resposta API: " + JSON.stringify(data), "info");

                    // Extract Balance (V5 uses saldo_total, handle potential variations)
                    const saldo = data.saldo_total !== undefined ? data.saldo_total : (data.saldo || 0);

                    if (saldo >= 0) {
                        log(`üí∞ Saldo dispon√≠vel: ${saldo} cr√©ditos`, "success");
                    } else {
                        log(`‚ö†Ô∏è Saldo retornou valor estranho: ${saldo}`, "warning");
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Erro API: ${response.status}`, "error");
                    // log(`   ${errorText}`, "error");
                }
            } catch (error) {
                log(`‚ùå Erro de conex√£o: ${error.message}`, "error");
            }
        }








        // Helper: Poll Kestra API for Completion
        async function waitForCompletion(executionId, config) {
            let baseUrl = config.webhookUrl.split('/executions/webhook/')[0];

            // List of URLs to try. 1: With 'main' (if present), 2: Without 'main' (cleanup)
            const urlsToTry = [];
            urlsToTry.push(`${baseUrl}/executions/${executionId}`);

            if (baseUrl.includes('/main')) {
                urlsToTry.push(baseUrl.replace('/main', '') + `/executions/${executionId}`);
            }

            log(`üîç Polling ID: ${executionId}`, "info");

            for (let i = 0; i < 20; i++) { // 20 attempts
                await new Promise(r => setTimeout(r, 1000));

                for (const executionUrl of urlsToTry) {
                    const fetchUrl = config.useProxy ?
                        `https://corsproxy.io/?${encodeURIComponent(executionUrl)}` :
                        executionUrl;

                    try {
                        const res = await fetch(fetchUrl);

                        if (res.status === 404) continue; // Try next URL or next attempt
                        if (res.status === 401 || res.status === 403) {
                            throw new Error(`Auth Error (${res.status}) - API Privada`);
                        }
                        if (!res.ok) throw new Error(`API Status ${res.status}`);

                        const pData = await res.json();
                        if (pData.state.current === 'SUCCESS' || pData.state.current === 'WARNING') {
                            return pData;
                        }
                        if (pData.state.current === 'FAILED' || pData.state.current === 'KILLED') {
                            throw new Error("Flow Failed");
                        }
                        // If still RUNNING/CREATED, break inner loop to wait and retry same URLs
                        break;
                    } catch (e) {
                        // Only log if it's a hard error, not just a 404 retry
                        if (!e.message.includes('404')) {
                            console.warn(`Poll error (${executionUrl}):`, e);
                            if (e.message.includes('Auth Error')) throw e; // Stop trying if auth failed
                        }
                    }
                }
            }
            throw new Error("Timeout waiting for execution");
        }

        window.onload = () => {
            loadConfig();
            log("Command Center V5.2 Inicializado. Backend: 09_command_center_backend");
        };
    </script>
</body>

</html>
